<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Cam Snap</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
    <script type="text/javascript" src="../js/webcam.min.js"></script>
    <script type="text/javascript">
        function take_snapshot() {
            $(document).ready(function() {
                $('#getMood').on('click', getEmotions);
            });

            Webcam.snap(function(data_uri) {
                document.getElementById('results').innerHTML = '<img id="base64image" src="'+data_uri+'"/><button onclick="SaveSnap();">Save Snap</button>';
            });
        }
        function ShowCam(){
            Webcam.set({
                width: 320,
                height: 240,
                image_format: 'jpeg',
                jpeg_quality: 100
            });
            Webcam.attach('#my_camera');
        }
        function SaveSnap(){
            document.getElementById("loading").innerHTML="Saving, please wait...";
            var file =  document.getElementById("base64image").src;
            var formdata = new FormData();
            formdata.append("base64image", file);
            console.log(formdata);
            var ajax = new XMLHttpRequest();
            ajax.addEventListener("load", function(event) { uploadcomplete(event);}, false);
            ajax.open("POST", "upload.php");
            ajax.send(formdata);
        }
        function uploadcomplete(event){
            document.getElementById("loading").innerHTML="";
            var image_return=event.target.responseText;
            var showup=document.getElementById("uploaded").src=image_return;
        }
        function getEmotions() {
            var apiKey = "1dd1f4e23a5743139399788aa30a7153";
            var apiUrl = "https://api.projectoxford.ai/emotion/v1.0/recognize";

            file = '';
            
            CallAPI(file,apiUrl,apiKey);

            function CallAPI(file, apiUrl, apiKey) {
                $.ajax({
                    url: apiUrl,
                    beforeSend: function (xhrObj) {
                        xhrObj.setRequestHeader("Content-Type", "application/json");
                        xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", apiKey);
                    },
                    type: "POST",
                    data: "{\"url\": \"http://bretthartman.net/facial-recognition/uploads/mypic.png\"}"
                })
                        .done(function (response) {
                            $('#response').html(response);
                            console.log(response[0])
                        })
                        .fail(function (error) {
                            console.log(error.getAllResponseHeaders());
                        });
            }
        }
        window.onload= ShowCam;
    </script>
    <style type="text/css">
        .container{display:inline-block;width:320px;}
        #Cam{background:rgb(255,255,215);}#Prev{background:rgb(255,255,155);}#Saved{background:rgb(255,255,55);}
    </style>
</head>
<body>
<div class="container" id="Cam"><b>Webcam Preview...</b>
    <div id="my_camera"></div><form><input type="button" value="Snap It" onClick="take_snapshot()"></form>
</div>
<div class="container" id="Prev">
    <b>Snap Preview...</b><div id="results"></div>
</div>
<div class="container" id="Saved">
    <b>Saved</b><span id="loading"></span><img id="uploaded" src=""/>
</div>
<button type="button" id="getMood">Get Mood</button>
</body>
</html>